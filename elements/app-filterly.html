<link rel="import" href="../styles/app-theme.html">
<link rel="import" href="layout/app-toolbar.html">

<link rel="import" href="app-config-behavior.html">

<dom-module id="app-filterly">

	<link rel="import" type="css" href="app-filterly.css">

	<style>
		:host {
			display: block;
			height: 100%;
		}

		iron-pages {
			height: 100%;
		}

		#page {
			background-image: url(../images/flower.jpg);
			background-size: cover;
			color: var(--text-primary-color);
			margin: 0px;
			padding: 0px;
		}
	</style>

	<template>

		<template id="loginpages" is="dom-if" if="{{!config.app.auth}}">

			<iron-pages id="page" attr-for-selected="data-route" selected="{{route}}">

				<section data-route="splash">
					<page-splash page="{{pageSelector}}"></page-splash>
				</section>

				<section data-route="login">
					<page-login user="{{loginUser}}" page="{{pageSelector}}"></page-login>
				</section>

				<section data-route="register">
					<page-register page="{{pageSelector}}"></page-register>
				</section>

				<section data-route="resetpassword">
					<page-resetpassword page="{{pageSelector}}"></page-resetpassword>
				</section>

				<section data-route="terms">
					<page-terms page="{{pageSelector}}"></page-terms>
				</section>

			</iron-pages>

		</template>

		<template is="dom-if" if="{{loginUser}}">

			<paper-drawer-panel id="paperDrawerPanel" right-drawer>
				<div drawer>
					<!-- Drawer Toolbar -->
					<paper-toolbar id="drawerToolbar">
						<span class="paper-font-title">Menu</span>
					</paper-toolbar>

					<!-- Drawer Content -->
					<paper-menu class="list" attr-for-selected="data-route" selected="{{route}}" on-iron-select="onMenuSelect">
						<a data-route="news" href="/news">
							<iron-icon icon="view-list"></iron-icon>
							<span>News</span>
						</a>

						<a data-route="categories" href="/categories">
							<iron-icon icon="dashboard"></iron-icon>
							<span>Categories</span>
						</a>

						<a data-route="profile" href="/profile">
							<iron-icon icon="face"></iron-icon>
							<span>Profile</span>
						</a>

						<a data-route="profile" href="/profile">
							<iron-icon icon="face"></iron-icon>
							<span>Profile</span>
						</a>

					</paper-menu>
				</div>
				<paper-header-panel main mode="waterfall">

					<!-- Main Toolbar -->

					<!--  <app-toolbar id="mainToolbar"></app-toolbar>-->

					<paper-toolbar id="mainToolbar">


						<div id="logo" class="paper-font-display2 app-name">

							<iron-image style="background-position-x: 100%;width:50%; height:50%; padding-top: 50px; margin-top: 8px;" sizing="cover" src="{{configuration.logo}}"></iron-image>

						</div>

						<span class="flex"></span>

						<paper-icon-button id="paperToggle" class="menu-button" icon="menu" paper-drawer-toggle> </paper-icon-button>
					</paper-toolbar>

					<!-- Main Content -->
					<div class="content">
						<iron-pages id="pageBase" attr-for-selected="data-route" selected="{{route}}">

							<section data-route="news">
								<page-news></page-news>
							</section>

							<section data-route="categories">
								<paper-material elevation="1">
									<h2 class="paper-font-display2">Categories</h2>

									<categorie-table></categorie-table>

								</paper-material>
							</section>

							<section data-route="profile">
								<paper-material elevation="1">
									<h2 class="paper-font-display2">Contact</h2>
									<page-profile user='{"name":"pepe","mail":"my@email.com","image":"/images/db/3.jpg"}' </page-profile>
										<google-map></google-map>
								</paper-material>
							</section>

						</iron-pages>
					</div>
				</paper-header-panel>
			</paper-drawer-panel>

		</template>


		<paper-toast id="caching-complete" duration="6000" text="Caching complete! This app will work offline.">
		</paper-toast>

		<platinum-sw-register auto-register clients-claim skip-waiting on-service-worker-installed="displayInstalledToast">
			<platinum-sw-cache default-cache-strategy="networkFirst" precache-file="precache.json">
			</platinum-sw-cache>
		</platinum-sw-register>

	</template>
</dom-module>

<script>
 Polymer({
		is: 'app-filterly',
		behaviors: [appConfig],
		properties: {
			loginUser: {
				type: Boolean,
				value: false
			},
			pagePrevius: {
				type: Array,
				value: function (){return [];}
			},
			pageSelector: {
				type: String,
				observer: '_changePage'
			},
			route: {
				type: String,
				value: ''
			},
			messageWidget: {
				type: Object
			}
		},
		onMenuSelect: function () {
			if (this.$.paperDrawerPanel.narrow) {
				this.$.paperDrawerPanel.closeDrawer();
			}
		},
		showMessage: function(data){

			console.info(data);
			if (data.type==='app:alert'){
				this.messageWidget.style.background='red';
				this.messageWidget.style.color='white';
			}

			this.messageWidget.text = data.detail.message;
			this.messageWidget.show();

		},
		_openMenu: function () {
			this.$.paperDrawerPanel.openDrawer();
		},
		_changePage: function (value) {

			if(value === '') return; // is necesary to enable use the "goto back" button two or more times

			if(value === 'goBack') {
				value = this.pagePrevius.pop();
				if(value === undefined ) value = 'splash';

			} else this.pagePrevius.push(this.route);

			page('/#!/'+value);
			this.route = value;

		},
		_messageWidget: function(){
			var self = this;
			this.messageWidget = document.querySelector('paper-toast');

			document.addEventListener('app:alert',function(erro){
				self.showMessage(erro);
			});

			document.addEventListener('app:message',function(erro){
				self.showMessage(erro);
			});

		},
		_initRoute: function(){
			if( window.location.hash === '#!/undefined') this._changePage('splash');

			if (this.config.app.auth ) {
				if( window.location.hash !== '#!/news' ) this._changePage('news');

			} else {

				// if( window.location.hash !== '#!/') this._changePage('splash');
				// if( window.location.hash !== '#!/' || window.location.pathname !== '/' ) this._changePage('splash');
			}
		},
		ready: function () {

			this._initRoute();
			this._messageWidget();

		}
	});

</script>
