<link rel="import" href="../styles/app-theme.html">
<link rel="import" href="layout/app-toolbar.html">

<link rel="import" href="app-config-behavior.html">

<dom-module id="app-filterly">

	<link rel="import" type="css" href="app-filterly.css">

	<style>
		:host {
			display: block;
			height: 100%;
		}

		iron-pages {
			height: 100%;
		}

		#page {
			background-image: url(../images/flower.jpg);
			background-size: cover;
			color: var(--text-primary-color);
			margin: 0px;
			padding: 0px;
		}

		#initcontent, #appcontent {
				display: none;
				height: 100%;
		}

		.show {
				display: block !important;
		}

	</style>

	<template>


		<section id="initcontent">
			<iron-pages id="page" attr-for-selected="data-route" selected="{{route}}">

				<section  data-route="splash">
					<page-splash  page="{{pageSelector}}"></page-splash>
				</section>

				<section data-route="login">
					<page-login user="{{loginUser}}" page="{{pageSelector}}"></page-login>
				</section>

				<section data-route="register">
					<page-register page="{{pageSelector}}"></page-register>
				</section>

				<section data-route="resetpassword">
					<page-resetpassword page="{{pageSelector}}"></page-resetpassword>
				</section>

				<section data-route="terms">
					<page-terms page="{{pageSelector}}"></page-terms>
				</section>

			</iron-pages>
		</section>

		<section id="appcontent">
			<paper-drawer-panel id="paperDrawerPanel" right-drawer>
					<div drawer>
						<!-- Drawer Toolbar -->
						<paper-toolbar id="drawerToolbar">
							<span class="paper-font-title">Menu</span>
						</paper-toolbar>

						<!-- Drawer Content -->
						<paper-menu class="list" attr-for-selected="data-route" selected="{{route}}" on-iron-select="onMenuSelect">
							<a data-route="news" href="/news">
								<iron-icon icon="view-list"></iron-icon>
								<span>{{config.location.tittleNews}}</span>
							</a>

							<a data-route="categories" href="/categories">
								<iron-icon icon="dashboard"></iron-icon>
								<span>{{config.location.tittleCategories}}</span>
							</a>

							<a data-route="profile" href="/profile">
								<iron-icon icon="face"></iron-icon>
								<span>{{config.location.tittleProfile}}</span>
							</a>

							<a data-route="logout" href="/logout">
								<iron-icon icon="close"></iron-icon>
								<span>{{config.location.tittleLogout}}</span>
							</a>

						</paper-menu>
					</div>
					<paper-header-panel main mode="waterfall">

						<!-- Main Toolbar -->

						<!--  <app-toolbar id="mainToolbar"></app-toolbar>-->

						<paper-toolbar id="mainToolbar">


							<div id="logo" class="paper-font-display2 app-name">

								<iron-image style="background-position-x: 100%;width:50%; height:50%; padding-top: 50px; margin-top: 8px;" sizing="cover" src="{{config.app.logo}}"></iron-image>

							</div>

							<span class="flex"></span>

							<paper-icon-button id="paperToggle" class="menu-button" icon="menu" paper-drawer-toggle> </paper-icon-button>
						</paper-toolbar>

						<!-- Main Content -->
						<div class="content">
							<iron-pages id="pageBase" attr-for-selected="data-route" selected="{{route}}">
								<section data-route="news">
									<page-news></page-news>
								</section>

								<section data-route="categories">
									<animation-tag animation="slideInUp">
										<paper-material elevation="1">
											<h2 class="paper-font-display2">{{config.location.tittleCategories}}</h2>
											<categorie-table></categorie-table>
										</paper-material>
									</animation-tag>
								</section>

								<section data-route="profile">
									<animation-tag animation="slideInUp">
										<paper-material elevation="1">
											<h2 class="paper-font-display2">{{config.location.tittleProfile}}</h2>
											<page-profile user='{"name":"pepe","mail":"my@email.com","image":"/images/db/3.jpg"}' </page-profile>
												<google-map></google-map>
										</paper-material>
									</animation-tag>
								</section>

								<section data-route="logout">
									<animation-tag animation="zoomIn">
										<paper-material elevation="1">
											<h2 class="paper-font-display2">{{config.location.tittleLogout}}</h2>
											<page-logout page="{{pageSelector}}" auth="{{authDetect}}"></page-logout>
										</paper-material>
									</animation-tag>
								</section>

							</iron-pages>
						</div>
					</paper-header-panel>
				</paper-drawer-panel>

		</section>


		<paper-toast id="caching-complete" duration="6000" text="Caching complete! This app will work offline.">
		</paper-toast>

		<platinum-sw-register auto-register clients-claim skip-waiting on-service-worker-installed="displayInstalledToast">
			<platinum-sw-cache default-cache-strategy="networkFirst" precache-file="precache.json">
			</platinum-sw-cache>
		</platinum-sw-register>

	</template>
</dom-module>

<script>
 Polymer({
		is: 'app-filterly',
		behaviors: [appConfig],
		properties: {
			loginUser: {
				type: Boolean,
				value: false
			},
			pagePrevius: {
				type: Array,
				value: function (){return [];}
			},
			pageSelector: {
				type: String,
				observer: '_changePage'
			},
			route: {
				type: String,
				value: ''
			},
			messageWidget: {
				type: Object
			},
			authDetect: {
					type: Boolean,
					value: true,
					observer: '_checkAuth'

			}
		},
		_checkAuth: function(){
				this.config.userProfile.auth = this.authDetect;

				if(this.config.userProfile.auth){
					this._showApp();
				}else{
					this._showInit();
				}

		},
		_showInit: function(){

			this.$.appcontent.classList.remove ('show');
			this.$.initcontent.classList.add ('show');

		},
		_showApp: function(){

			this.$.appcontent.classList.add ('show');
			this.$.initcontent.classList.remove ('show');

		},
		onMenuSelect: function () {
			if (this.$.paperDrawerPanel.narrow) {
				this.$.paperDrawerPanel.closeDrawer();
			}
		},
		_openMenu: function () {
			this.$.paperDrawerPanel.openDrawer();
		},
		_changePage: function (value) {

			if(value === '') return; // is necesary to enable use the "goto back" button two or more times

			if(value === 'goBack') {
				value = this.pagePrevius.pop();
				if(value === undefined ) value = 'splash';

			} else this.pagePrevius.push(this.route);

			page('/#!/'+value);
			this.route = value;

		},
		showMessage: function(data){

			console.info(data);
			if (data.type==='app:alert'){
				this.messageWidget.style.background='red';
				this.messageWidget.style.color='white';
			}

			this.messageWidget.text = data.detail.message;
			this.messageWidget.show();

		},
		_initMessageWidget: function(){
			var self = this;
			this.messageWidget = document.querySelector('paper-toast');

			document.addEventListener('app:alert',function(erro){
				self.showMessage(erro);
			});

			document.addEventListener('app:message',function(erro){
				self.showMessage(erro);
			});

		},
		_initRoute: function(){
			if( window.location.hash === '#!/undefined') this._changePage('splash');

			this.config.consoldev('user auth : ' + this.config.userProfile.auth);

			if ( this.config.userProfile.auth ) {

				this._showApp();

				if( window.location.hash !== '#!/news' ) this._changePage('news');

			} else {
				this._showInit();
				// Fix Safari and firefox splash.
				if( window.location.hash !== '#!/') this._changePage('splash');
				// if( window.location.hash !== '#!/' || window.location.pathname !== '/' ) this._changePage('splash');
			}
		},
		ready: function () {

			//this.authDetect = this.config.userProfile;
			this._initRoute();
			this._initMessageWidget();

		}
	});

</script>
